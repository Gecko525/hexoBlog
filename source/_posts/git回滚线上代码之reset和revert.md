---
title: git回滚线上代码之reset和revert
date: 2021-09-24 16:08:53
tags: git
---



> 当使用git作为多人合作开发的代码仓库时，避免不了因某个提交有问题而回退代码的情况。此时，可以使用这个两个命令解决：reset(回退)、revert(重做)。

<!-- more -->

## 区别

先来说下两者的区别：

**reset**:  修改`HEAD`的位置，即将`HEAD`指向的位置改变为之前某个版本，**且目标版本之后的版本都会被丢弃**，适合目标版本之后的版本都不要了的情况。

**revert**:  用于**反做**某一个版本，以达到撤销该版本的修改的目的。反做后会撤销某个版本的修改，并**生成一个新的提交**，且会**保留这个版本之后的提交**。

## reset详解

1. **git reset --hard 目标版本号**

该命令修改`HEAD`的位置，即将`HEAD`指向的位置改变为之前存在的某个版本，最后需要用 `git push -f` 强推到远端。

**该命令会将本地的修改也回退**，即不会保留本地的修改，所以在执行之前最好先执行`git stash`。

2. **git reset --mixed 目标版本号**

默认选项。缓存区会被回退，但本地修改不受影响。

3. **git reset --soft 目标版本号**

仅修改`HEAD`的位置，缓存区和本地修改都将被保留。

> 总结：--hard --mixed(default) --soft 分别覆盖3个、2个、1个位置的代码，--mixed（默认的参数）只会保留本地修改（working copy）的代码

使用步骤：

```
git reset --hard 目标版本号
git push -f origin/分支名称
```

## revert详解

1. **git revert 版本号**

撤销某个版本所有的提交，并自动生成一个新的提交。

2. **git revert -n 版本号**

撤销某个版本所有的提交，但不会自动生成一个新的提交，需要手动提交。

使用步骤：

```
git revert -n 版本号
```

**此时可能会出现冲突，需要手动修改冲突，然后将修改添加到缓存区并提交。**如果没有冲突可以直接提交并推送远程。

```
git add .
git commit -m "revert xxxx"
git push origin/分支
```

> 建议使用`revert` 回退线上代码，因为`reset`只会修改`HEAD`的位置，当强制推送到远程时，如果其他开发者已将这个版本之后的提交拉取到了本地，此时再拉取的时候并不会将本地的`HEAD`指向这个版本，需要所有开发者手动将本地`HEAD`指向这个版本。而revert会生成一个新的提交，其他开发者拉取代码时会将这个提交一起拉到本地，不需要其他任何操作。

